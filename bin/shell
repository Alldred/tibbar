#!/bin/zsh
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Stuart Alldred. All Rights Reserved

# Check for TIBBAR_ROOT already being set in the shell
if [[ "$TIBBAR_ROOT" != "" ]]; then
    echo "[\033[0;31mERROR\033[0m] Tibbar shell is already activated!"
    exit 1
fi

# Work out where the repository is located
TIBBAR_ROOT=$(readlink -f ${0:a:h}/..)
if [[ -d "$TIBBAR_ROOT/.git" ]]; then
    echo "[INFO] Updating git submodules..."
    git -C "$TIBBAR_ROOT" submodule update --init
fi

# Parse --dev option (strip from args so it isn't passed to zsh)
SHELL_ARGS=()
UV_EXTRAS=()
for arg in "$@"; do
    if [[ "$arg" == "--dev" ]]; then
        UV_EXTRAS=(--extra dev)
    else
        SHELL_ARGS+=("$arg")
    fi
done

# Check and update all dependencies before entering the shell
(
    cd "$TIBBAR_ROOT" || exit 1
    uv lock --upgrade
    uv sync "${UV_EXTRAS[@]}"
) || {
    echo "[\033[0;31mERROR\033[0m] Failed to update dependencies via uv" >&2
    exit 1
}
echo "[\033[0;32mINFO\033[0m] Tibbar dependencies are up to date."

USER_HISTFILE=${HISTFILE:-$HOME/.zsh_history}

TIBBAR_ROOT=$TIBBAR_ROOT \
    USER_HISTFILE=$USER_HISTFILE \
    ZDOTDIR=$TIBBAR_ROOT/bin/zsh \
    /bin/zsh -i "${SHELL_ARGS[@]}"
